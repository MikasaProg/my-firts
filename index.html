<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Family Cloud Pro</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --primary: #74aa50; --danger: #e74c3c; --accent: #4a90e2;
            --bg: var(--tg-theme-bg-color, #f4f7f6);
            --card: var(--tg-theme-secondary-bg-color, #ffffff);
            --text: var(--tg-theme-text-color, #333);
        }
        body { font-family: system-ui, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 10px; padding-bottom: 50px; }
        .card { background: var(--card); padding: 15px; border-radius: 18px; margin-bottom: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .flex { display: flex; gap: 8px; margin-top: 10px; }
        input { padding: 10px; border: 1px solid rgba(0,0,0,0.1); border-radius: 10px; background: var(--bg); color: var(--text); flex: 1; outline: none; }
        .btn { background: var(--primary); color: white; border: none; padding: 10px 15px; border-radius: 10px; font-weight: bold; cursor: pointer; }
        .user-selector { display: flex; background: rgba(0,0,0,0.05); padding: 4px; border-radius: 12px; margin-bottom: 15px; }
        .u-btn { flex: 1; border: none; padding: 8px; border-radius: 10px; background: none; color: var(--text); cursor: pointer; transition: 0.3s; }
        .u-btn.active { background: var(--primary); color: white; }
        .row { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid rgba(0,0,0,0.03); }
        .food-item { font-size: 13px; color: var(--accent); padding: 4px 0; border-bottom: 1px dashed rgba(0,0,0,0.1); }
        #status { position: fixed; bottom: 10px; left: 50%; transform: translateX(-50%); font-size: 10px; opacity: 0.6; }
        #loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); display: flex; justify-content: center; align-items: center; z-index: 1000; }
    </style>
</head>
<body>

<div id="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>

<div class="user-selector">
    <button class="u-btn active" id="btn-Artem" onclick="switchUser('Artem')">–ê—Ä—Ç–µ–º</button>
    <button class="u-btn" id="btn-Veronika" onclick="switchUser('Veronika')">–í–µ—Ä–æ–Ω–∏–∫–∞</button>
</div>

<div class="card" style="text-align: center;">
    <h2 id="dateDisplay">...</h2>
    <div id="status">–û–±–ª–∞–∫–æ: –Ω–∞ —Å–≤—è–∑–∏ ‚úÖ</div>
</div>

<div class="card">
    <h3>üí∞ –ë–∞–ª–∞–Ω—Å: <span id="moneyNet">0</span> ‚ÇΩ</h3>
    <div class="flex">
        <input type="number" id="moneyInp" placeholder="–°—É–º–º–∞">
        <button class="btn" onclick="addMoney(true)">+</button>
        <button class="btn" style="background:var(--danger)" onclick="addMoney(false)">-</button>
    </div>
</div>

<div class="card">
    <h3>‚úÖ –ü—Ä–∏–≤—ã—á–∫–∏</h3>
    <div id="habitsCont">
        <div class="row"><span>üìñ –ß—Ç–µ–Ω–∏–µ</span><input type="checkbox" id="h-read" onchange="sync()"></div>
        <div class="row"><span>üèãÔ∏è –°–ø–æ—Ä—Ç</span><input type="checkbox" id="h-sport" onchange="sync()"></div>
    </div>
</div>

<div class="card">
    <h3>üçé –ï–¥–∞ (–¶–µ–ª—å: 2000)</h3>
    <div style="font-size: 18px; margin-bottom: 10px;">–§–∞–∫—Ç: <b id="cF">0</b> –∫–∫–∞–ª</div>
    <div class="flex">
        <input type="text" id="fName" placeholder="–ß—Ç–æ —Å—ä–µ–ª?">
        <input type="number" id="fCal" placeholder="–∫–∫–∞–ª" style="width: 70px;">
        <button class="btn" onclick="addFood()">–û–ö</button>
    </div>
    <div id="foodList" style="margin-top: 15px; max-height: 150px; overflow-y: auto;"></div>
</div>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    const DB_URL = "https://family-b4799-default-rtdb.europe-west1.firebasedatabase.app/"; 
    let currentUser = "Artem";
    let dayKey = new Date().toLocaleDateString('ru-RU').replace(/\./g, '-');

    // –ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ (—Å–±–æ—Ä –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö –≤ –æ–±—ä–µ–∫—Ç)
    async function sync() {
        const data = {
            money: parseInt(document.getElementById('moneyNet').innerText),
            calFact: parseInt(document.getElementById('cF').innerText),
            habits: {
                read: document.getElementById('h-read').checked,
                sport: document.getElementById('h-sport').checked
            },
            foods: Array.from(document.querySelectorAll('.food-item')).map(el => el.innerText)
        };

        await fetch(`${DB_URL}/users/${currentUser}/${dayKey}.json`, {
            method: 'PUT',
            body: JSON.stringify(data)
        });
        tg.HapticFeedback.impactOccurred('light');
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —é–∑–µ—Ä–∞
    async function loadData() {
        document.getElementById('loading').style.display = 'flex';
        document.getElementById('dateDisplay').innerText = new Date().toLocaleDateString('ru-RU', {day:'numeric', month:'long'});
        
        const res = await fetch(`${DB_URL}/users/${currentUser}/${dayKey}.json`);
        const d = await res.json() || {};

        // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª—è
        document.getElementById('moneyNet').innerText = d.money || 0;
        document.getElementById('cF').innerText = d.calFact || 0;
        document.getElementById('h-read').checked = d.habits?.read || false;
        document.getElementById('h-sport').checked = d.habits?.sport || false;
        
        const list = document.getElementById('foodList');
        list.innerHTML = '';
        if(d.foods) d.foods.forEach(f => {
            list.innerHTML += `<div class="food-item">${f}</div>`;
        });

        document.getElementById('loading').style.display = 'none';
    }

    function switchUser(name) {
        currentUser = name;
        document.querySelectorAll('.u-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('btn-' + name).classList.add('active');
        loadData();
    }

    async function addMoney(isPlus) {
        const val = parseInt(document.getElementById('moneyInp').value) || 0;
        const cur = parseInt(document.getElementById('moneyNet').innerText);
        document.getElementById('moneyNet').innerText = isPlus ? cur + val : cur - val;
        document.getElementById('moneyInp').value = '';
        await sync();
    }

    async function addFood() {
        const name = document.getElementById('fName').value || "–ï–¥–∞";
        const cal = parseInt(document.getElementById('fCal').value) || 0;
        const curFact = parseInt(document.getElementById('cF').innerText);
        
        document.getElementById('cF').innerText = curFact + cal;
        document.getElementById('foodList').innerHTML += `<div class="food-item">${name} (${cal} –∫–∫–∞–ª)</div>`;
        
        document.getElementById('fName').value = '';
        document.getElementById('fCal').value = '';
        await sync();
    }

    loadData();
</script>
</body>
</html>
