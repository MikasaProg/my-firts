<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Family Tracker Elite</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #74aa50; --danger: #e74c3c; --accent: #4a90e2;
            --bg: var(--tg-theme-bg-color, #f4f7f6);
            --card: var(--tg-theme-secondary-bg-color, #ffffff);
            --text: var(--tg-theme-text-color, #333);
            --hint: var(--tg-theme-hint-color, #888);
        }
        body { font-family: -apple-system, system-ui, sans-serif; background: var(--bg); margin: 0; padding: 10px; color: var(--text); }
        .sync-mini { position: fixed; top: 5px; right: 10px; font-size: 10px; opacity: 0.6; }
        .status-header { display: flex; gap: 10px; margin-bottom: 15px; }
        .status-item { flex: 1; background: var(--card); padding: 12px; border-radius: 15px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .status-emoji { font-size: 28px; display: block; }
        .user-tabs { display: flex; background: rgba(0,0,0,0.05); padding: 3px; border-radius: 12px; margin-bottom: 15px; }
        .tab-btn { flex: 1; padding: 8px; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; background: none; color: var(--text); }
        .tab-btn.active { background: var(--card); color: var(--primary); }
        .day-nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; background: var(--card); padding: 8px 15px; border-radius: 12px; }
        .section-card { background: var(--card); padding: 15px; border-radius: 18px; box-shadow: 0 2px 10px rgba(0,0,0,0.03); margin-bottom: 12px; }
        .row { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid rgba(0,0,0,0.05); }
        input, select { padding: 8px; border: 1px solid rgba(0,0,0,0.1); border-radius: 8px; background: var(--bg); color: var(--text); font-size: 14px; outline: none; }
        .btn-ok { background: var(--primary); color: white; border: none; padding: 8px 12px; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .btn-del { color: var(--danger); border: none; background: none; font-size: 18px; cursor: pointer; font-weight: bold; padding: 0 5px; }
        .food-log { font-size: 11px; color: var(--hint); margin-top: 8px; display: none; background: rgba(0,0,0,0.02); padding: 8px; border-radius: 10px; }
        .num-input { width: 45px; text-align: center; border: none; background: rgba(0,0,0,0.03); border-radius: 5px; }
        #loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); display: flex; justify-content: center; align-items: center; z-index: 2000; font-weight: bold; }
    </style>
</head>
<body>

<div id="sync-indicator" class="sync-mini">‚òÅÔ∏è Sync OK</div>
<div id="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>

<div class="app-container">
    <div class="status-header">
        <div class="status-item">
            <span id="dayEmo" class="status-emoji">üò¥</span>
            <span id="dayText" style="font-weight:bold; font-size:14px;">–û–∂–∏–¥–∞–Ω–∏–µ</span>
            <div style="font-size:10px; color:var(--hint)">–¶–ï–õ–¨ –î–ù–Ø</div>
        </div>
        <div class="status-item">
            <span id="weekEmo" class="status-emoji">üìâ</span>
            <span id="weekText" style="font-weight:bold; font-size:14px;">...</span>
            <div style="font-size:10px; color:var(--hint)">–ù–ï–î–ï–õ–Ø</div>
        </div>
    </div>

    <div class="user-tabs">
        <button id="btn-–ê—Ä—Ç–µ–º" class="tab-btn active" onclick="switchUser('–ê—Ä—Ç–µ–º')">–ê—Ä—Ç–µ–º</button>
        <button id="btn-–í–µ—Ä–æ–Ω–∏–∫–∞" class="tab-btn" onclick="switchUser('–í–µ—Ä–æ–Ω–∏–∫–∞')">–í–µ—Ä–æ–Ω–∏–∫–∞</button>
    </div>

    <div class="day-nav">
        <button class="btn-ok" onclick="changeDay(-1)">‚ùÆ</button>
        <b id="dateDisplay">...</b>
        <button class="btn-ok" onclick="changeDay(1)">‚ùØ</button>
    </div>

    <div class="section-card">
        <h3>üìú –ü—Ä–∏–≤—ã—á–∫–∏</h3>
        <div class="row"><span>üìñ –ß—Ç–µ–Ω–∏–µ</span><input type="checkbox" id="h-read" onchange="save()"></div>
        <div class="row"><span>üèãÔ∏è –°–ø–æ—Ä—Ç</span><input type="checkbox" id="h-sport" onchange="save()"></div>
        <div id="customList"></div>
        <div style="margin-top:10px; display:flex; flex-wrap: wrap; gap:5px;">
            <select id="newEmo" style="font-size:18px;"><option>üéØ</option><option>üíß</option><option>üëü</option><option>üíä</option><option>üßò</option></select>
            <input type="text" id="newName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ..." style="flex:1">
            <select id="newType"><option value="check">‚òëÔ∏è</option><option value="num">üî¢</option></select>
            <div style="font-size: 10px; display: flex; align-items: center; gap: 3px;">
                <input type="checkbox" id="newInStat" checked> <label for="newInStat">–£—á–∏—Ç—ã–≤–∞—Ç—å</label>
            </div>
            <button class="btn-ok" style="width:100%" onclick="addCustom()">–î–æ–±–∞–≤–∏—Ç—å</button>
        </div>
    </div>

    <div class="section-card">
        <h3>üçé –ü–∏—Ç–∞–Ω–∏–µ (–¶–µ–ª—å: <input type="number" id="cN" style="width:50px; border:none; background:none; font-weight:bold" onchange="save()">)</h3>
        <div>–§–∞–∫—Ç: <b id="cF_val">0</b> –∫–∫–∞–ª</div>
        <div style="display:flex; gap:5px; margin-top:10px;">
            <input type="text" id="fName" placeholder="–ï–¥–∞..." style="flex:1">
            <input type="number" id="fCal" placeholder="–∫–∫–∞–ª" style="width:60px">
            <button class="btn-ok" onclick="addFood()">–û–ö</button>
        </div>
        <button onclick="toggleFoodLog()" style="background:none; border:none; color:var(--accent); font-size:11px; margin-top:8px; cursor:pointer;">‚ñº –ò—Å—Ç–æ—Ä–∏—è –µ–¥—ã</button>
        <div id="fLog" class="food-log"></div>
    </div>

    <div class="section-card">
        <h3>üí∞ –°—Ä–µ–¥—Å—Ç–≤–∞: <span id="moneyNet">0</span></h3>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
            <div style="display:flex; gap:3px;"><input type="number" id="plusMoney" placeholder="+" style="width:100%"><button class="btn-ok" onclick="modMoney(true)">OK</button></div>
            <div style="display:flex; gap:3px;"><input type="number" id="minusMoney" placeholder="-" style="width:100%"><button class="btn-ok" style="background:var(--danger)" onclick="modMoney(false)">OK</button></div>
        </div>
    </div>

    <div class="section-card" style="height: 200px;"><canvas id="mainChart"></canvas></div>
</div>

<script>
    const tg = window.Telegram.WebApp;
    const DB_URL = "https://family-b4799-default-rtdb.europe-west1.firebasedatabase.app/"; 
    let user = '–ê—Ä—Ç–µ–º', day = new Date().getDate(), chart;

    async function save() {
        document.getElementById('sync-indicator').innerText = '‚è≥ Syncing...';
        const foodItems = Array.from(document.querySelectorAll('.food-item-row')).map(el => ({
            n: el.dataset.n, c: parseInt(el.dataset.c)
        }));
        const data = {
            money: parseInt(document.getElementById('moneyNet').innerText),
            cN: parseInt(document.getElementById('cN').value) || 2000,
            cF: foodItems.reduce((a, b) => a + b.c, 0),
            read: document.getElementById('h-read').checked,
            sport: document.getElementById('h-sport').checked,
            foodItems: foodItems,
            customs: Array.from(document.querySelectorAll('.c-row')).map(el => ({
                name: el.querySelector('.c-name').innerText,
                type: el.dataset.type,
                inStat: el.dataset.instat === 'true',
                val: el.dataset.type === 'check' ? el.querySelector('input').checked : parseInt(el.querySelector('.c-f').value) || 0,
                goal: el.dataset.type === 'num' ? parseInt(el.querySelector('.c-g').value) || 0 : 0
            }))
        };
        await fetch(`${DB_URL}/u/${user}/d${day}.json`, { method: 'PUT', body: JSON.stringify(data) });
        document.getElementById('sync-indicator').innerText = '‚òÅÔ∏è Sync OK';
        updateUI();
    }

    async function load() {
        document.getElementById('loading').style.display = 'flex';
        document.getElementById('dateDisplay').innerText = `${day} –§–µ–≤—Ä–∞–ª—è`;
        const res = await fetch(`${DB_URL}/u/${user}/d${day}.json`);
        const d = await res.json() || {};

        document.getElementById('moneyNet').innerText = d.money || 0;
        document.getElementById('cN').value = d.cN || 2000;
        document.getElementById('cF_val').innerText = d.cF || 0;
        document.getElementById('h-read').checked = d.read || false;
        document.getElementById('h-sport').checked = d.sport || false;
        
        const log = document.getElementById('fLog'); log.innerHTML = '';
        if(d.foodItems) d.foodItems.forEach(item => {
            log.innerHTML += `<div class="row food-item-row" data-n="${item.n}" data-c="${item.c}"><span>${item.n} (${item.c})</span><button class="btn-del" onclick="removeFood(this)">√ó</button></div>`;
        });

        const cont = document.getElementById('customList'); cont.innerHTML = '';
        if(d.customs) d.customs.forEach(c => {
            let ctrl = c.type === 'check' ? `<input type="checkbox" ${c.val?'checked':''} onchange="save()">` : `<div style="display:flex; gap:3px;"><input type="number" class="num-input c-f" value="${c.val}" onchange="save()"><small>/</small><input type="number" class="num-input c-g" value="${c.goal}" onchange="save()"></div>`;
            cont.innerHTML += `<div class="row c-row" data-type="${c.type}" data-instat="${c.inStat || false}"><div style="display:flex; align-items:center;"><button class="btn-del" onclick="this.closest('.row').remove(); save();">√ó</button><span class="c-name">${c.name}</span>${c.inStat ? '‚≠ê' : ''}</div>${ctrl}</div>`;
        });
        document.getElementById('loading').style.display = 'none';
        updateUI();
    }

    function addFood() {
        const n = document.getElementById('fName').value || '–ï–¥–∞';
        const c = parseInt(document.getElementById('fCal').value) || 0;
        document.getElementById('fLog').innerHTML += `<div class="row food-item-row" data-n="${n}" data-c="${c}"><span>${n} (${c})</span><button class="btn-del" onclick="removeFood(this)">√ó</button></div>`;
        document.getElementById('fName').value = ''; document.getElementById('fCal').value = ''; save();
    }

    function removeFood(btn) { btn.closest('.food-item-row').remove(); save(); }
    function toggleFoodLog() { const l = document.getElementById('fLog'); l.style.display = l.style.display === 'block' ? 'none' : 'block'; }

    function addCustom() {
        const name = document.getElementById('newEmo').value + " " + document.getElementById('newName').value;
        const type = document.getElementById('newType').value;
        const inStat = document.getElementById('newInStat').checked;
        if(!document.getElementById('newName').value) return;
        
        let ctrl = type === 'check' ? `<input type="checkbox" onchange="save()">` : `<div style="display:flex; gap:3px;"><input type="number" class="num-input c-f" value="0" onchange="save()"><small>/</small><input type="number" class="num-input c-g" value="10" onchange="save()"></div>`;
        document.getElementById('customList').innerHTML += `<div class="row c-row" data-type="${type}" data-instat="${inStat}"><div style="display:flex; align-items:center;"><button class="btn-del" onclick="this.closest('.row').remove(); save();">√ó</button><span class="c-name">${name}</span>${inStat ? '‚≠ê' : ''}</div>${ctrl}</div>`;
        document.getElementById('newName').value = ''; save();
    }

    function modMoney(isP) {
        const id = isP ? 'plusMoney' : 'minusMoney';
        const v = parseInt(document.getElementById(id).value) || 0;
        const net = parseInt(document.getElementById('moneyNet').innerText);
        document.getElementById('moneyNet').innerText = isP ? net + v : net - v;
        document.getElementById(id).value = ''; save();
    }

    function switchUser(n) { user = n; document.querySelectorAll('.tab-btn').forEach(b => b.classList.toggle('active', b.innerText === n)); load(); }
    function changeDay(v) { day = Math.max(1, Math.min(28, day + v)); load(); }

    async function updateUI() {
        let done = 0, total = 3;
        const cF = Array.from(document.querySelectorAll('.food-item-row')).reduce((a, b) => a + parseInt(b.dataset.c), 0);
        document.getElementById('cF_val').innerText = cF;
        if(document.getElementById('h-read').checked) done++;
        if(document.getElementById('h-sport').checked) done++;
        if(cF > 0 && Math.abs(cF - parseInt(document.getElementById('cN').value)) < 200) done++;
        
        document.querySelectorAll('.c-row').forEach(el => {
            if(el.dataset.instat === 'true') {
                total++;
                if(el.dataset.type === 'check' && el.querySelector('input').checked) done++;
                if(el.dataset.type === 'num' && parseInt(el.querySelector('.c-f').value) >= parseInt(el.querySelector('.c-g').value)) done++;
            }
        });

        const p = done / total;
        const status = p > 0.8 ? ["üöÄ", "–°—É–ø–µ—Ä"] : p > 0.5 ? ["ü•á", "–•–æ—Ä–æ—à–æ"] : p > 0.2 ? ["ü•à", "–ù–æ—Ä–º"] : ["ü•â", "–ü–ª–æ—Ö–æ"];
        document.getElementById('dayEmo').innerText = status[0];
        document.getElementById('dayText').innerText = status[1];
        updateChart();
    }

    async function updateChart() {
        let vals = [], labels = [];
        for(let i = day - 6; i <= day; i++) {
            if (i <= 0) continue;
            labels.push(i);
            const r = await fetch(`${DB_URL}/u/${user}/d${i}.json`);
            const d = await r.json() || {};
            let s = (d.read?1:0) + (d.sport?1:0);
            if(d.customs) d.customs.forEach(c => { 
                if(c.inStat) {
                    if(c.type==='check' && c.val) s++; 
                    if(c.type==='num' && c.val>=c.goal) s++; 
                }
            });
            vals.push(s);
        }
        const ctx = document.getElementById('mainChart').getContext('2d');
        if(chart) chart.destroy();
        chart = new Chart(ctx, { type: 'line', data: { labels, datasets: [{ data: vals, borderColor: '#74aa50', tension: 0.4 }] }, options: { maintainAspectRatio: false, plugins: { legend: { display: false } } } });
    }
    load();
</script>
</body>
</html>
