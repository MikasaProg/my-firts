<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Family Tracker Mini App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #74aa50;
            --danger: #e74c3c;
            --accent: #4a90e2;
            --bg: var(--tg-theme-bg-color, #f4f7f6);
            --card: var(--tg-theme-secondary-bg-color, #ffffff);
            --text: var(--tg-theme-text-color, #333);
            --hint: var(--tg-theme-hint-color, #888);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: var(--bg);
            margin: 0;
            padding: 10px;
            color: var(--text);
            overscroll-behavior: none; /* –û—Ç–∫–ª—é—á–∞–µ–º –ª–∏—à–Ω–∏–µ —Å–≤–∞–π–ø—ã –≤ –¢–ì */
        }

        .app-container { max-width: 600px; margin: 0 auto; }
        
        /* –°—Ç–∞—Ç—É—Å—ã */
        .status-header { display: flex; gap: 10px; margin-bottom: 15px; }
        .status-item { 
            flex: 1; 
            background: var(--card); 
            padding: 12px; 
            border-radius: 15px; 
            text-align: center; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.05); 
        }
        .status-emoji { font-size: 28px; display: block; }
        .status-text { font-weight: bold; font-size: 0.9em; display: block; margin-top: 5px; }
        .status-label { font-size: 10px; color: var(--hint); text-transform: uppercase; }

        /* –í–∫–ª–∞–¥–∫–∏ */
        .user-tabs { display: flex; border-radius: 12px; background: rgba(0,0,0,0.05); padding: 3px; margin-bottom: 15px; }
        .tab-btn { 
            flex: 1; padding: 8px; border: none; border-radius: 10px; 
            cursor: pointer; font-weight: bold; background: none; color: var(--text); 
        }
        .tab-btn.active { background: var(--card); color: var(--primary); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

        /* –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –¥–∞—Ç–∞–º */
        .day-nav { 
            display: flex; justify-content: space-between; align-items: center; 
            margin-bottom: 15px; background: var(--card); padding: 8px 15px; border-radius: 12px; 
        }
        .day-nav button { background: rgba(0,0,0,0.05); border: none; padding: 5px 12px; border-radius: 8px; color: var(--text); }

        /* –ö–∞—Ä—Ç–æ—á–∫–∏ */
        .section-card { 
            background: var(--card); padding: 15px; border-radius: 18px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.03); margin-bottom: 12px; 
        }
        h3 { margin: 0 0 12px 0; font-size: 1em; color: var(--hint); border-bottom: 1px solid rgba(0,0,0,0.05); padding-bottom: 5px; }

        .row { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid rgba(0,0,0,0.03); }
        
        input, select { 
            padding: 8px; border: 1px solid rgba(0,0,0,0.1); border-radius: 8px; 
            background: var(--bg); color: var(--text); font-size: 14px; outline: none;
        }

        /* –ü–∏—Ç–∞–Ω–∏–µ –∏ –§–∏–Ω–∞–Ω—Å—ã */
        .input-group { display: flex; flex-direction: column; gap: 8px; margin-top: 10px; }
        .flex-row { display: flex; gap: 5px; }
        .btn-ok { 
            background: var(--primary); color: white; border: none; 
            padding: 8px 12px; border-radius: 8px; font-weight: bold; cursor: pointer; 
        }
        .btn-del { color: var(--danger); border: none; background: none; font-weight: bold; cursor: pointer; }
        
        .food-list { 
            margin-top: 10px; padding: 8px; background: rgba(0,0,0,0.02); 
            border-radius: 10px; font-size: 12px; display: none; 
        }
        .food-list.active { display: block; }

        .chart-card { height: 250px; width: 100%; }
    </style>
</head>
<body>

<div class="app-container">
    <div class="status-header">
        <div class="status-item">
            <span id="dayEmo" class="status-emoji">üò¥</span>
            <span id="dayText" class="status-text">...</span>
            <span class="status-label">–¶–µ–ª—å –¥–Ω—è</span>
        </div>
        <div class="status-item">
            <span id="weekEmo" class="status-emoji">‚è≥</span>
            <span id="weekText" class="status-text">...</span>
            <span class="status-label">–ù–µ–¥–µ–ª—è</span>
        </div>
    </div>

    <div class="user-tabs">
        <button id="btn-–ê—Ä—Ç–µ–º" class="tab-btn active" onclick="setUser('–ê—Ä—Ç–µ–º')">–ê—Ä—Ç–µ–º</button>
        <button id="btn-–í–µ—Ä–æ–Ω–∏–∫–∞" class="tab-btn" onclick="setUser('–í–µ—Ä–æ–Ω–∏–∫–∞')">–í–µ—Ä–æ–Ω–∏–∫–∞</button>
    </div>

    <div class="day-nav">
        <button onclick="changeDay(-1)">‚ùÆ</button>
        <b id="dateDisplay">...</b>
        <button onclick="changeDay(1)">‚ùØ</button>
    </div>

    <div class="section-card">
        <h3>üìú –ü—Ä–∏–≤—ã—á–∫–∏</h3>
        <div class="row"><span>üìñ –ß—Ç–µ–Ω–∏–µ</span><input type="checkbox" id="read" onchange="save()"></div>
        <div class="row"><span>üèãÔ∏è –°–ø–æ—Ä—Ç</span><input type="checkbox" id="sport" onchange="save()"></div>
        <div id="dynamicList"></div>
        <div class="input-group">
            <div class="flex-row">
                <input type="text" id="newN" placeholder="–ù–æ–≤–æ–µ –ø–æ–ª–µ..." style="flex:1">
                <button class="btn-ok" onclick="addField()">+</button>
            </div>
        </div>
    </div>

    <div class="section-card">
        <h3>üçé –ü–∏—Ç–∞–Ω–∏–µ (–∫–∫–∞–ª)</h3>
        <div class="flex-row" style="margin-bottom:10px;">
            <input type="number" id="cN" style="width:50%" placeholder="–¶–µ–ª—å" oninput="save()">
            <input type="number" id="cF" style="width:50%" placeholder="–§–∞–∫—Ç" readonly style="opacity:0.7">
        </div>
        <div class="input-group" style="background: rgba(0,0,0,0.02); padding: 10px; border-radius: 12px;">
            <input type="text" id="foodName" placeholder="–ü—Ä–æ–¥—É–∫—Ç..." oninput="autoSearch(this.value)">
            <div class="flex-row">
                <input type="number" id="foodCal" placeholder="–∫–∫–∞–ª" style="flex:1">
                <button class="btn-ok" onclick="addFood()">–î–æ–±–∞–≤–∏—Ç—å –µ–¥—É</button>
            </div>
            <button onclick="document.getElementById('foodLog').classList.toggle('active')" style="background:none; border:none; color:var(--accent); font-size:11px; text-align:left; padding:0;">‚ñº –ü–æ–∫–∞–∑–∞—Ç—å —Å—ä–µ–¥–µ–Ω–Ω–æ–µ</button>
            <div id="foodLog" class="food-list"></div>
        </div>
    </div>

    <div class="section-card">
        <h3>üí∞ –§–∏–Ω–∞–Ω—Å—ã (–ë–∞–ª–∞–Ω—Å: <span id="moneyNet">0</span>)</h3>
        <div class="flex-row">
            <input type="number" id="moneyInp" placeholder="–°—É–º–º–∞" style="flex:1">
            <button class="btn-ok" onclick="modMoney(true)">+</button>
            <button class="btn-ok" style="background:var(--danger)" onclick="modMoney(false)">-</button>
            <button class="btn-ok" style="background:#95a5a6" onclick="undoMoney()">‚¨ÖÔ∏è</button>
        </div>
    </div>

    <div class="section-card chart-card">
        <canvas id="mainChart"></canvas>
    </div>
</div>

<script>
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram
    const tg = window.Telegram.WebApp;
    tg.expand();

    let user = '–ê—Ä—Ç–µ–º', day = new Date().getDate(), chart;
    let schema = JSON.parse(localStorage.getItem('schema') || '[]');

    const foodDB = {
        "–∫—É—Ä–∏—Ü–∞": 165, "—Ä–∏—Å": 130, "—è–±–ª–æ–∫–æ": 52, "–±–∞–Ω–∞–Ω": 89, "—è–π—Ü–æ": 155, 
        "—Ç–≤–æ—Ä–æ–≥": 120, "–≥—Ä–µ—á–∫–∞": 110, "–æ–≤—Å—è–Ω–∫–∞": 68, "–∫–æ—Ñ–µ": 40, "—Å—ã—Ä": 350
    };

    function setUser(n) { 
        user = n; 
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.toggle('active', b.innerText === n));
        load(); 
    }
    
    function changeDay(d) { 
        day = Math.max(1, Math.min(31, day + d)); 
        load(); 
    }

    function autoSearch(val) {
        const q = val.toLowerCase().trim();
        if (foodDB[q]) document.getElementById('foodCal').value = foodDB[q];
    }

    function addFood() {
        const n = document.getElementById('foodName').value || '–ï–¥–∞';
        const c = parseFloat(document.getElementById('foodCal').value) || 0;
        const d = JSON.parse(localStorage.getItem(`${user}-d${day}`)) || {};
        if(!d.foodStack) d.foodStack = [];
        d.foodStack.push({name: n, cal: c});
        d.cF = d.foodStack.reduce((a, b) => a + b.cal, 0);
        localStorage.setItem(`${user}-d${day}`, JSON.stringify(d));
        document.getElementById('foodName').value = '';
        document.getElementById('foodCal').value = '';
        load();
        tg.HapticFeedback.notificationOccurred('success');
    }

    function delFood(idx) {
        const d = JSON.parse(localStorage.getItem(`${user}-d${day}`)) || {};
        d.foodStack.splice(idx, 1);
        d.cF = d.foodStack.reduce((a, b) => a + b.cal, 0);
        localStorage.setItem(`${user}-d${day}`, JSON.stringify(d));
        load();
    }

    function modMoney(isEarn) {
        const val = parseFloat(document.getElementById('moneyInp').value) || 0;
        if(val <= 0) return;
        const d = JSON.parse(localStorage.getItem(`${user}-d${day}`)) || {};
        const key = isEarn ? 'eS' : 'sS';
        if(!d[key]) d[key] = [];
        d[key].push(val);
        d[isEarn?'e':'sp'] = d[key].reduce((a,b)=>a+b, 0);
        localStorage.setItem(`${user}-d${day}`, JSON.stringify(d));
        document.getElementById('moneyInp').value = '';
        load();
        tg.HapticFeedback.impactOccurred('medium');
    }

    function undoMoney() {
        const d = JSON.parse(localStorage.getItem(`${user}-d${day}`)) || {};
        if(d.eS) d.eS.pop(); if(d.sS) d.sS.pop();
        d.e = (d.eS || []).reduce((a,b)=>a+b, 0);
        d.sp = (d.sS || []).reduce((a,b)=>a+b, 0);
        localStorage.setItem(`${user}-d${day}`, JSON.stringify(d));
        load();
    }

    function addField() {
        const n = document.getElementById('newN').value;
        if(!n) return;
        schema.push({ id: Date.now(), name: n });
        localStorage.setItem('schema', JSON.stringify(schema));
        document.getElementById('newN').value = '';
        load();
    }

    function save() {
        const d = JSON.parse(localStorage.getItem(`${user}-d${day}`)) || {};
        d.r = document.getElementById('read').checked;
        d.s = document.getElementById('sport').checked;
        d.cN = document.getElementById('cN').value;
        d.custom = d.custom || {};
        schema.forEach(f => { d.custom[f.id] = document.getElementById('c-'+f.id).checked; });
        localStorage.setItem(`${user}-d${day}`, JSON.stringify(d));
        updateUI();
    }

    function load() {
        document.getElementById('dateDisplay').innerText = `${day} –§–µ–≤`;
        const d = JSON.parse(localStorage.getItem(`${user}-d${day}`)) || {};
        document.getElementById('read').checked = d.r || false;
        document.getElementById('sport').checked = d.s || false;
        document.getElementById('cN').value = d.cN || '';
        document.getElementById('cF').value = d.cF || 0;
        document.getElementById('moneyNet').innerText = (d.e || 0) - (d.sp || 0);

        const log = document.getElementById('foodLog'); log.innerHTML = '';
        (d.foodStack || []).forEach((item, i) => {
            log.innerHTML += `<div class="food-item" style="display:flex; justify-content:space-between; padding:4px 0;"><span>${item.name}</span><span>${item.cal} <button class="btn-del" onclick="delFood(${i})">√ó</button></span></div>`;
        });

        const cont = document.getElementById('dynamicList'); cont.innerHTML = '';
        schema.forEach(f => {
            const div = document.createElement('div'); div.className = 'row';
            const val = (d.custom && d.custom[f.id]) || false;
            div.innerHTML = `<span>${f.name}</span><input type="checkbox" id="c-${f.id}" onchange="save()" ${val?'checked':''}>`;
            cont.appendChild(div);
        });
        updateUI();
    }

    function updateUI() {
        const d = JSON.parse(localStorage.getItem(`${user}-d${day}`)) || {};
        let s = 0, t = 3 + schema.length;
        if(d.r) s++; if(d.s) s++;
        if(d.cN && Math.abs((d.cF-d.cN)/d.cN) <= 0.15) s++;
        schema.forEach(f => { if(d.custom && d.custom[f.id]) s++; });
        const p = s / t;
        const status = p > 0.8 ? ["üöÄ", "–°—É–ø–µ—Ä"] : p > 0.5 ? ["ü•á", "–•–æ—Ä–æ—à–æ"] : p > 0.2 ? ["ü•à", "–ù–æ—Ä–º"] : ["ü•â", "–ü–ª–æ—Ö–æ"];
        document.getElementById('dayEmo').innerText = status[0];
        document.getElementById('dayText').innerText = status[1];
        updateChart();
    }

    function updateChart() {
        let scores = [];
        for(let i=1; i<=31; i++) {
            const d = JSON.parse(localStorage.getItem(`${user}-d${i}`)) || {};
            let s = 0;
            if(d.r) s++; if(d.s) s++;
            if(d.cN && Math.abs((d.cF-d.cN)/d.cN) <= 0.15) s++;
            schema.forEach(f => { if(d.custom && d.custom[f.id]) s++; });
            scores.push(s);
        }
        const ctx = document.getElementById('mainChart').getContext('2d');
        if(chart) chart.destroy();
        chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: Array.from({length:31}, (_,i)=>i+1),
                datasets: [{ 
                    label: '–¶–µ–ª–∏', data: scores, 
                    borderColor: '#74aa50', tension: 0.4, fill: true, 
                    backgroundColor: 'rgba(116, 170, 80, 0.1)', pointRadius: 2 
                }]
            },
            options: { 
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: { y: { display: false }, x: { grid: { display: false } } }
            }
        });
    }
    load();
</script>
</body>
</html>